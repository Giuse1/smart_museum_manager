{"version":1,"allow_edit":true,"plugins":[],"panes":[{"title":"Devices Status","width":1,"row":{"2":1,"3":1,"4":1,"5":1},"col":{"2":2,"3":1,"4":1,"5":1},"col_width":1,"widgets":[{"type":"indicator","settings":{"title":"Light Status","value":"return datasources[\"Light\"].msg.msg","on_text":"ON","off_text":"OFF"}},{"type":"indicator","settings":{"title":"Heating Status","value":"return datasources[\"Heat\"].msg.msg","on_text":"ON","off_text":"OFF"}}]},{"title":"Control Switches","width":1,"row":{"2":11,"3":7,"4":7,"5":7},"col":{"2":2,"3":1,"4":1,"5":1},"col_width":1,"widgets":[{"type":"html","settings":{"html":"<!DOCTYPE html>\n\n<html>\n\n\t<body>\n\n\t\t<button title=\"off\" id=\"light_btn\" onclick=\"changeStat('light')\" style=\"width:100px;height:100px; margin-left:20px;\">Light</button>\n\n\t\t<button title=\"off\" id=\"heating_btn\" onclick=\"changeStat('heat')\" style=\"width:100px;height:100px; margin-left:52px;\">Heating</button>\n\n\t\t\n\n\t\t<form onsubmit=\"return false\">\n\n\t\t\t<div class=\"row\">\n\n\t\t\t\t<div class=\"col-25\" style=\"margin-top:25px; margin-left:5px\">\n\n\t\t\t\t\t<label for=\"thvalue\">New Threshold</label>\n\n\t\t\t\t</div>\n\n\t\t\t\t<div class=\"col-75\" style=\"margin-left:5px; margin-top:5px\">\n\n\t\t\t\t\t<input type=\"text\" id=\"thvalue\" name=\"thvalue\" placeholder=\"Set new value..\">\n\n\t\t\t\t</div>\n\n\t\t\t</div>\n\n\t\t\t\n\n\t\t\t<div class=\"row\">\n\n\t\t\t\t<div class=\"col-25\" style=\"margin-top:10px; margin-left:5px\">\n\n\t\t\t\t\t<label for=\"thtype\">Set Quantity</label>\n\n\t\t\t\t</div>\n\n\t\t\t\t<div class=\"col-75\" style=\"margin-left:5px; margin-top:3px\">\n\n\t\t\t\t\t<select id=\"thtype\" name=\"thtype\">\n\n\t\t\t\t\t\t<option value=\"maxTemperature\">Max Temperature</option>ok ci \n                        \n                        <option value=\"minTemperature\">Min Temperature</option>\n\n\t\t\t\t\t\t<option value=\"humidity\">Humidity</option>\n\n\t\t\t\t\t\t<option value=\"max_people\">Max People</option>\n\n\t\t\t\t\t\t<option value=\"light_timer\">Light Timer</option>\n\n\t\t\t\t\t</select>\n\n\t\t\t\t</div>\n\n\t\t\t</div>\n\n\t\t\t\n\n\t\t\t<div class=\"row\" style=\"margin-top:17px; margin-left:5px\">\n\n\t\t\t\t<input type=\"submit\" value = \"Submit\" onclick=\"changeTh()\"></input>\n\n\t\t\t</div>\n\n\t\t</form>\n\n\t\t</div> \n\n  \t\t\n\n\t\t<script src=\"https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js\" type=\"text/javascript\"></script>\n\n\t\t<script>\n\n\t\t\tfunction changeStat(relay){\n\n\t\t\t\tvar light = document.getElementById(\"light_btn\");\n\n\t\t\t\tvar heat = document.getElementById(\"heating_btn\");\t\t\t\n\n\n\n\t\t\t\tif (relay == \"light\") {\n\n\t\t\t\t\tMQTTconnect(\"light\");\n\n\t\t\t\t} else {\n\n\t\t\t\t\tMQTTconnect(\"heat\");\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t\n\n\t\t\tvar mqtt;\n\n\t\t\tvar reconnectTimeout = 2000;\n\n\t\t\tvar host=\"172.20.10.11\";\n\n\t\t\tvar port=9001;\n\n\t\t\tvar dev;\n\n\n\n\t\t\tfunction onConnectPane2() {\n\n\t\t\t\tconsole.log(\"Connected \");\n\n\t\t\t\tif (dev == \"light\"){\n\n\t\t\t\t\tMQTTsend(\"trigger/light\");\n\n\t\t\t\t} else if (dev == \"heat\"){\n\n\t\t\t\t\tMQTTsend(\"trigger/heat\");    \n\n\t\t\t\t} else if (dev == \"th\"){\n\n\t\t\t\t\tMQTTsend(\"trigger/th\")\n\n\t\t\t\t} else if (dev == \"sub\"){\n\n\t\t\t\t\tconsole.log(\"subscribed\");\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t\n\n\t\t\tfunction MQTTsend(topic){\n                \n\t\t\t\tvar json_msg = '{\"msg\":\"void\"}';\n                message = new Paho.MQTT.Message(json_msg);\n\t\t\t\tmessage.destinationName = topic;\n\t\t\t\tmqtt.send(message);\n\n\t\t\t\tconsole.log(\"Published\");\n\n\t\t\t\talert(\"Message Sent!\");\n\n\t\t\t}\n\n\t\t\t\n\n\t\t\tfunction MQTTconnect(cmd) {\n\n\t\t\t\tdev = cmd;\n\n\t\t\t\tmqtt = new Paho.MQTT.Client(host,port,\"freeboard_mqtt\");\n\n\t\t\t\tconsole.log(\"connecting to \"+ host +\" \"+ port);\n\n\t\t\t\tvar options = {\n\n\t\t\t\t\ttimeout: 3,\n\n\t\t\t\t\tonSuccess: onConnectPane2,\n\n\t\t\t\t};\n\n\t\t\t\tmqtt.connect(options); \n\n\t\t\t}\n\n\n\n\t\t\tfunction changeTh(){\n\n                var value = document.getElementById(\"thvalue\").value;\n\t\t\t\tvar type = document.getElementById(\"thtype\").value;\n                console.log(value);\n                if (value==\"\"){\n                    alert(\"WARNING: Insert a valid threshold.\");\n                }else{\n\t                if (type==\"minTemperature\"){\n\t                    httpPost(\"http://172.20.10.11:9090/th?type=min_temperature_th&val=\"+value);\n\t                } else if (type==\"maxTemperature\"){\n\t                    httpPost(\"http://172.20.10.11:9090/th?type=max_temperature_th&val=\"+value);\n\t                } else if (type==\"humidity\"){\n\t                    httpPost(\"http://172.20.10.11:9090/th?type=humidity_th&val=\"+value);\n\t                } else if (type==\"max_people\"){\n\t                    httpPost(\"http://172.20.10.11:9090/th?type=people_th&val=\"+value);\n\t                } else{\n\t                    httpPost(\"http://172.20.10.11:9090/th?type=light_timer&val=\"+value);\n\t                }\n                \n\t                MQTTconnect(\"th\")\n                }\n                \n                \n\t\t\t}\n\n\t\tfunction httpPost(URL){\n            var xmlHttp = new XMLHttpRequest();\n            xmlHttp.onreadystatechange = function() {\n                if (this.readyState == 4 && this.status == 200) {\n                    var res = this.responseText;\n                }\n            };\n            xmlHttp.open(\"POST\", URL, true);\n            xmlHttp.send();\n        }\n\t\n\n\t\t</script> \n     \n\n\t</body>\n\n</html>","height":6}},{"type":"text_widget","settings":{"size":"regular","value":"if (datasources[\"Alert\"].topic == \"alert/temperature\"){\n    alert(\"WARNING: Critical Temperature value :\" + datasources[\"Alert\"].msg.msg + \" C\");\n } else if (datasources[\"Alert\"].topic == \"alert/humidity\"){\n     alert(\"WARNING:  Critical Humidity value :\" + datasources[\"Alert\"].msg.msg + \" %\");\n } else if (datasources[\"Alert\"].topic == \"alert/people\"){\n     alert(\"WARNING:  Critical number of people inside :\" + datasources[\"Alert\"].msg.msg + \" people\");\n } else if (datasources[\"Alert\"].topic == \"alert/light_down\"){\n     alert(\"WARNING:  Lights are OFF\");\n } else if (datasources[\"Alert\"].topic == \"alert/closing\"){\n     alert(\"WARNING:  The museum is closing. Lights and heating are shutting down.\");\n }\nreturn \" \"; \n","animate":true}}]},{"title":"Room Parameters","width":1,"row":{"2":11,"3":19,"4":19,"5":1},"col":{"2":1,"3":3,"4":3,"5":5},"col_width":1,"widgets":[{"type":"text_widget","settings":{"title":"Temperature","size":"regular","value":"datasources[\"Room Parameters\"][\"feeds\"][\"0\"][\"field1\"]","animate":true,"units":"C"}},{"type":"text_widget","settings":{"title":"Humidity","size":"regular","value":"datasources[\"Room Parameters\"][\"feeds\"][\"0\"][\"field2\"]","animate":true,"units":"%"}},{"type":"text_widget","settings":{"title":"People Inside","size":"regular","value":"datasources[\"Room Parameters\"][\"feeds\"][\"0\"][\"field3\"]","animate":true,"units":"People"}}]},{"width":1,"row":{"2":7,"3":31,"5":15},"col":{"2":1,"3":1,"5":2},"col_width":3,"widgets":[{"type":"text_widget","settings":{"size":"regular","value":"var date = datasources[\"Room Parameters\"][\"feeds\"][\"0\"][\"created_at\"].split(\":\")[0];\nvar minutes = datasources[\"Room Parameters\"][\"feeds\"][\"0\"][\"created_at\"].split(\":\")[1];\nvar seconds = datasources[\"Room Parameters\"][\"feeds\"][\"0\"][\"created_at\"].split(\":\")[2].split(\"Z\")[0];\nvar hour = Number(date.split(\"T\")[1]);\nhour = hour+2;\nvar date = date.split(\"T\")[0];\nreturn \"Last acquisition:\\n\"+date+\" At \"+hour+\":\"+minutes+\":\"+seconds","animate":true}}]},{"title":"Statistics","width":1,"row":{"2":27,"3":35,"4":29,"5":1},"col":{"2":1,"3":1,"4":1,"5":2},"col_width":3,"widgets":[{"type":"sparkline","settings":{"title":"Temperature","value":"datasources[\"Room Parameters\"][\"feeds\"][\"0\"][\"field1\"]"}},{"type":"sparkline","settings":{"title":"Humidity","value":"datasources[\"Room Parameters\"][\"feeds\"][\"0\"][\"field2\"]"}},{"type":"sparkline","settings":{"title":"People Inside","value":"datasources[\"Room Parameters\"][\"feeds\"][\"0\"][\"field3\"]"}}]}],"datasources":[{"name":"Room Parameters","type":"JSON","settings":{"url":"https://api.thingspeak.com/channels/699095/feeds.json?api_key=U17R0YH2YW9OBOZJ&results=1","use_thingproxy":true,"refresh":30,"method":"GET"}},{"name":"Alert","type":"paho_mqtt","settings":{"server":"172.20.10.11","port":9001,"use_ssl":false,"client_id":"freeboard","username":"","password":"","topic":"alert/#","json_data":true,"name":"Alert"}},{"name":"Light","type":"paho_mqtt","settings":{"server":"172.20.10.11","port":9001,"use_ssl":false,"client_id":"freeboard_dev","username":"","password":"","topic":"measure/light_stat","json_data":true,"name":"Light"}},{"name":"Heat","type":"paho_mqtt","settings":{"server":"172.20.10.11","port":9001,"use_ssl":false,"client_id":"dev_heat","username":"","password":"","topic":"measure/heat_stat","json_data":true}}],"columns":5}